let MonitorConnPool = {
    remote_conn_url:"http://"+window.location.hostname+":8019/videoServer/v2/",
    intervalList:{},
    /**
     * 播放视频
     * @param key --- 该video的id，与vms中的id保持一致
     * @param videoDOM --- 该video的DOM对象
     */
    play:(key,videoDOM)=>{
        let startHeartBeatSign = true;
        $.ajax({
            data:{key:key},
            type: "GET",
            dataType:"JSON",
            contentType: "application/json",
            scriptCharset: "utf-8",
            url: MonitorConnPool.remote_conn_url+"monitor/key",
            error: function (error) {
                console.error(error);
            },
            success: function (result) {
               let url = result.data;
               let tempInterval = setInterval(()=>{
                    $.ajax({
                        data: {key:key},
                        type: "GET",
                        dataType: "JSON",
                        contentType: "application/json",
                        scriptCharset: "utf-8",
                        url: MonitorConnPool.remote_conn_url+"monitor/ready",
                        error: function (error) {
                            console.error(error);
                        },
                        success: function (result) {
                            if(startHeartBeatSign){
                                MonitorConnPool.startHeartBeatDetection(key);
                                startHeartBeatSign = false;
                            }
                            if(parseInt(result.code) === 200){
                                if (Hls.isSupported()) {
                                    let video = videoDOM;
                                    if(typeof video !== "object") {
                                        console.error("second args videoDOM must be a document obj.");
                                        return false;
                                    }
                                    let hls = new Hls();
                                    hls.loadSource(url);
                                    hls.attachMedia(video);
                                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                                        video.play();
                                    });
                                    clearInterval(tempInterval);
                                }
                            }
                        }
                    });
                },300);
            }
        });
    },
    /**
     * 开启心跳检测
     * @param id --- 该video的id，与VMS中的id保持一致
     */
    startHeartBeatDetection: (id)=>{
       let heartBeatObj = setInterval(()=>{
            $.ajax({
                data: "",
                type: "GET",
                dataType:"JSON",
                contentType: "application/json",
                scriptCharset: "utf-8",
                url: MonitorConnPool.remote_conn_url+"monitor/"+id+"/heartBeatDetection",
                error: function (error) {
                    console.error(error);
                },
                success: function (result) {

                }
            });
        },1000*3);
        MonitorConnPool.intervalList[id] = {};
        MonitorConnPool.intervalList[id] = heartBeatObj;
    },
    /**
     * 关闭心跳检测
     * @param id --- 该video的id，与VMS中的id保持一致
     */
    shutOffHeartBeatDetection: (id)=>{
        let heartBeatObj = MonitorConnPool.intervalList[id];
        if(heartBeatObj){
            clearInterval(heartBeatObj);
            delete MonitorConnPool.intervalList[id];
        }else{
            console.error("no heartbeat detection could be found when id = "+id+".");
        }
    }
};


